---
sudo: required
services: docker
language: generic

before_script:
  - sudo apt-get -y install qemu-user-static
  - sudo -E docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
  - (cd .. && git clone https://github.com/estesp/manifest-tool)
  - (cd ../manifest-tool && git checkout v0.9.0)
  - (cd ../manifest-tool && sudo -E make && sudo -E make install)

jobs:
  include:
    - stage: build xtesting images
      script: sudo -E bash build.sh
      env:
        - REPO="${DOCKER_USERNAME}"
        - arch="amd64"
    - script: sudo -E bash build.sh
      env:
        - REPO="${DOCKER_USERNAME}"
        - arch="arm"
    - script: sudo -E bash build.sh
      env:
        - REPO="${DOCKER_USERNAME}"
        - arch="arm64"
    - stage: publish xtesting manifests
      script: >
        sudo manifest-tool push from-args \
          --platforms linux/amd64,linux/arm,linux/arm64 \
          --template ${DOCKER_USERNAME}/xtesting:ARCH-hunter \
          --target ${DOCKER_USERNAME}/xtesting:hunter
